# Maintainer: RATIU5
pkgname=chronos-apple-studio-display
pkgver=0.0.1
pkgrel=1
pkgdesc="Essential drivers and utilities for Apple Studio Display hardware support on Wayland/Hyprland"
arch=('x86_64')
url="https://github.com/RATIU5/chronos"
license=(MIT)

depends=(
    'linux-headers'
    'linux-firmware'
    'libdrm'
    'libusb'
    'udev'
    'rust'
    'cargo'
    'ddcutil'
    'bolt'
    'mesa'
    'wayland'
    'wayland-protocols'
    'hyprland'
    'xdg-desktop-portal-hyprland'
)

optdepends=(
    'wdisplays: GUI for monitor configuration'
    'nwg-displays: Alternative GUI for monitor arrangement'
    'kanshi: Dynamic display configuration'
)

source=()

sha256sums=()

prepare() {
    # Enhanced udev rules for Apple Studio Display with better permissions
    cat > "${srcdir}/50-apple-studio-display.rules" << 'EOF'
# Apple Studio Display HID devices
KERNEL=="hiddev*", ATTRS{idVendor}=="05ac", ATTRS{idProduct}=="1114", GROUP="users", OWNER="root", MODE="0660", TAG+="uaccess"
KERNEL=="hiddev*", ATTRS{idVendor}=="05ac", ATTRS{idProduct}=="9243", GROUP="users", OWNER="root", MODE="0660", TAG+="uaccess"

# Apple Studio Display USB devices
SUBSYSTEM=="usb", ATTRS{idVendor}=="05ac", ATTRS{idProduct}=="1114", TAG+="uaccess"
SUBSYSTEM=="usb", ATTRS{idVendor}=="05ac", ATTRS{idProduct}=="9243", TAG+="uaccess"

# Apple Studio Display audio/video devices
SUBSYSTEM=="video4linux", ATTRS{idVendor}=="05ac", ATTRS{idProduct}=="1114", TAG+="uaccess"
SUBSYSTEM=="sound", ATTRS{idVendor}=="05ac", ATTRS{idProduct}=="1114", TAG+="uaccess"
EOF

    # Enhanced DisplayPort detection for Wayland
    cat > "${srcdir}/90-displayport-detection.rules" << 'EOF'
# Force DisplayPort detection on hotplug for Wayland compositors
SUBSYSTEM=="drm", ACTION=="change", ENV{HOTPLUG}=="1", RUN+="/bin/sh -c 'echo detect > /sys/class/drm/card*/status'"

# USB-C DisplayPort Alt Mode detection
SUBSYSTEM=="typec", ACTION=="add", ATTR{power_role}=="source", ATTR{data_role}=="host", RUN+="/bin/sh -c 'echo 1 > /sys/class/drm/card*/card*/drm/card*/status'"
EOF

    # Thunderbolt/USB4 auto-authorization for Apple displays
    cat > "${srcdir}/95-thunderbolt-apple-display.rules" << 'EOF'
# Auto-authorize Apple Studio Display via Thunderbolt/USB4
ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{vendor}=="0x1", ATTR{device}=="0x1114", ATTR{authorized}=="0", ATTR{authorized}="1"
ACTION=="add", SUBSYSTEM=="thunderbolt", ATTR{vendor}=="0x1", ATTR{device}=="0x9243", ATTR{authorized}=="0", ATTR{authorized}="1"
EOF

    # X11 display configuration for AMD GPU compatibility
    cat > "${srcdir}/apple-studio-display-x11.conf" << 'EOF'
# X11 DisplayPort configuration for Apple Studio Display - AMD GPU
Section "Device"
    Identifier "AMD"
    Driver "amdgpu"
    Option "DRI" "3"
    Option "TearFree" "true"
EndSection
EOF

    # Wayland-specific monitor configuration helper
    cat > "${srcdir}/apple-studio-display-wayland-setup" << 'EOF'
#!/bin/bash
# Helper script for Apple Studio Display Wayland setup

# Check if running Wayland
if [ "$XDG_SESSION_TYPE" != "wayland" ];
then
    echo "This script is for Wayland sessions only"
    exit 1
fi

# Create monitors configuration directory if it doesn't exist
mkdir -p ~/.config/hypr/

# Create Apple Studio Display configuration for Hyprland with AMD GPU workaround
cat > ~/.config/hypr/apple-studio-display.conf << 'HYPR_EOF'
# Apple Studio Display configuration for Hyprland
# Use highres to automatically select the highest available resolution.
monitor=,highres,auto,1
HYPR_EOF

echo "Apple Studio Display Hyprland configuration created at ~/.config/hypr/apple-studio-display.conf"
echo "Add 'source = ~/.config/hypr/apple-studio-display.conf' to your hyprland.conf"
EOF

    cd "${srcdir}"
    git clone https://github.com/juliuszint/asdbctl.git
    cd asdbctl
    cargo build --release
}

package() {
    install -Dm644 "${srcdir}/50-apple-studio-display.rules" \
        "${pkgdir}/etc/udev/rules.d/50-apple-studio-display.rules"

    install -Dm644 "${srcdir}/90-displayport-detection.rules" \
        "${pkgdir}/etc/udev/rules.d/90-displayport-detection.rules"

    install -Dm644 "${srcdir}/95-thunderbolt-apple-display.rules" \
        "${pkgdir}/etc/udev/rules.d/95-thunderbolt-apple-display.rules"

    install -Dm644 "${srcdir}/apple-studio-display-x11.conf" \
        "${pkgdir}/etc/X11/xorg.conf.d/20-apple-studio-display.conf"

    install -Dm755 "${srcdir}/apple-studio-display-wayland-setup" \
        "${pkgdir}/usr/bin/apple-studio-display-wayland-setup"

    install -Dm755 "${srcdir}/asdbctl/target/release/asdbctl" \
        "${pkgdir}/usr/bin/asdbctl"

    ln -sf /usr/bin/asdbctl "${pkgdir}/usr/bin/apple-brightness"

    # Studio Display connector fix - simple hotplug detection
    cat > "${srcdir}/studio-display-reset" << 'EOF'
#!/bin/bash
# Fix Studio Display by triggering hotplug detection

fix_display() {
    echo "Triggering Studio Display hotplug detection..."

    # Check available files first
    echo "Available DP-3 files:"
    ls /sys/class/drm/card1-DP-3/ 2>/dev/null | head -5
    echo "Available DP-4 files:"
    ls /sys/class/drm/card1-DP-4/ 2>/dev/null | head -5

    # Force detection on both connectors
    for dp in DP-3 DP-4; do
        if [ -e "/sys/class/drm/card1-$dp/status" ]; then
            echo "Triggering detection on $dp..."
            echo detect > "/sys/class/drm/card1-$dp/status" 2>/dev/null || echo "  Failed to trigger $dp"
        fi
    done

    echo "Hotplug detection completed"
}

case "$1" in
    fix|reset|refresh)
        fix_display
        ;;
    status)
        echo "Studio Display connector status:"
        echo "DP-3: $(cat /sys/class/drm/card1-DP-3/status 2>/dev/null || echo 'unknown')"
        echo "DP-4: $(cat /sys/class/drm/card1-DP-4/status 2>/dev/null || echo 'unknown')"
        echo ""
        echo "DP-3 modes:"
        head -3 /sys/class/drm/card1-DP-3/modes 2>/dev/null || echo "none"
        echo "DP-4 modes:"
        head -3 /sys/class/drm/card1-DP-4/modes 2>/dev/null || echo "none"
        ;;
    *)
        echo "Usage: $0 {fix|status}"
        echo "Triggers hotplug detection for Studio Display"
        ;;
esac
EOF

    install -Dm755 "${srcdir}/studio-display-reset" \
        "${pkgdir}/usr/bin/studio-display-reset"
}
